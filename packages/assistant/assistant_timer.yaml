timer:
  # Timer attivato vocalmente
  spoken:
    name: Timer
    icon: mdi:timer

intent_script:

  SetCountdownAlarm:
    action:
      - service: script.say_something
        data_template:
          message: !include ../../templates/it/assistant_SetCountdownAlarm.yaml
      - service: timer.cancel
        data:
          entity_id: timer.spoken
      - service: timer.start
        data_template:
          entity_id: timer.spoken
          duration: "{{ duration }}"

  ClearCountdownAlarm:
    action:
      # TODO controllo timer in esecuzione
      - service: script.say_something
        data_template:
          message: !include ../../templates/it/assistant_ClearCountdownAlarm.yaml
      - service: timer.cancel
        data:
          entity_id: timer.spoken

  GetCountdownAlarm:
    action:
      # Trucchetto per ottenere il tempo rimanente aggiornato
      - service: timer.pause
        data:
          entity_id: timer.spoken
      - service: timer.start
        data:
          entity_id: timer.spoken
      # TODO controllo timer in esecuzione
      - service: script.say_something
        data_template:
          message: !include ../../templates/it/assistant_GetCountdownAlarm.yaml

automation:

  - alias: TimerFinished
    trigger:
      platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.spoken
    action:
      - condition: state
        entity_id: timer.spoken
        state: idle
      - service: media_player.volume_set
        data:
          entity_id: media_player.lounge
          volume_level: !secret lounge_volume
      - service: media_player.play_media
        data:
          entity_id: media_player.lounge
          media_content_id: !secret alarm_media_url
          media_content_type: music
