homeassistant:
  customize:
    script.goodmorning:
      friendly_name: Buongiorno!
      icon: mdi:coffee

intent_script:

  TrashReminderMorning:
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.trash_reminder_morning
      - service: script.say_something
        data_template:
          message: !include ../../templates/it/assistant_TrashReminderMorning.yaml

  GreetingGoodMorning:
    action:
      - service: script.goodmorning

  GreetingGeneral:
    action:
      - event: assistant_speak_tts
        event_data:
          template: GreetingGeneral

  Thankyou:
    action:
      - event: assistant_speak_tts
        event_data:
          template: thankyou

  AnnounceGoingAway:
    action:
      - service: script.announce_going_away

  # Saluto della buonanotte
  GreetingGoodNight:
    action:
      - service: script.night_mode
      - event: assistant_speak_tts
        event_data:
          template: goodnight

input_boolean:

  # TODO prevedere variabile per indicare il giorno del reminder
  trash_reminder_morning:
    name: 'Porta la spazzatura domattina'
    initial: off
    icon: mdi:recycle

automation:

  # Avvisa di viaggi duri al lavoro se in mattina feriale e c'Ã¨ qualcuno in casa
  - alias: work_commute_hard
    trigger:
      - platform: numeric_state
        entity_id: sensor.commute_to_work
        above: 35
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: binary_sensor.workmorning_sensor
          state: 'on'
        - condition: numeric_state
          entity_id: sensor.people_home_count
          above: '0'
    action:
      - service: script.say_something
        data_template:
          message: !include ../../templates/it/assistant_work_commute_hard.yaml

  - alias: karen_internet_unavailable
    trigger:
      - platform: state
        entity_id: device_tracker.internet
        from: 'home'
        to: 'not_home'
    action:
      - service: script.say_something_rendered
        data:
          url: !secret karen_internet_unavailable_url

  - alias: karen_internet_restored
    trigger:
      - platform: state
        entity_id: device_tracker.internet
        from: 'not_home'
        to: 'home'
    action:
      - service: script.say_something_rendered
        data:
          url: !secret karen_internet_restored_url

script:

  # Saluto del buongiorno
  goodmorning:
    sequence:
      - event: assistant_speak_tts
        event_data:
          template: goodmorning
      - condition: template
        value_template: '{{ 4 <= now().hour < 10 }}'
      - delay:
          seconds: 10
      - wait_template: "{{ is_state('media_player.lounge', 'idle') or is_state('media_player.lounge', 'paused') }}"
        timeout: '00:01:00'
      - service: media_player.volume_set
        data:
          entity_id: media_player.lounge
          volume_level: !secret lounge_volume
      - service: media_player.play_media
        data_template:
          entity_id: media_player.lounge
          media_content_id: >-
            {% set hour = states('sensor.time').split(':')[0] %}
            https://cdn.rtl.it/RTLFM/on-demand/giornale-orario/go_{{ hour }}.mp3
          media_content_type: music

  # Bentornato a casa
  welcome_home:
    sequence:
      - event: assistant_speak_tts
        event_data:
          template: welcome_home
      - condition: template
        value_template: '{{ (now().hour == 20 and now().minute < 10) or (now().hour == 19 and now().minute > 50) }}'
      - delay:
          seconds: 5
      #- wait_template: "{{ is_state('media_player.lounge', 'idle') or is_state('media_player.lounge', 'paused') }}"
      #  timeout: '00:01:00'
      - service: script.tv_channel_favourite_news

  # Andando via
  # TODO da sistemare con altre informazioni
  # TODO sfruttare macro
  # TODO variazioni di testo
  announce_going_away:
    sequence:
      - service: script.say_something
        data_template:
          message: !include ../../templates/it/assistant_announce_going_away.yaml
      - service: input_boolean.turn_off
        entity_id: input_boolean.trash_reminder_morning
      - service: switch.turn_on
        entity_id: switch.homeserver
